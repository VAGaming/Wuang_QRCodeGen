<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QR - 30</title>
    <style>
      :root {
        --size: 320px;
        --green: #2ecc71;
        --red: #e74c3c;
        --bg: #f7f9fb;
        --card: #fff;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: #222;
      }
      .wrap {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .card {
        background: var(--card);
        padding: 28px;
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(35, 50, 80, 0.08);
        text-align: center;
        max-width: 420px;
        width: 100%;
      }
      h1 {
        margin: 0 0 14px;
        font-size: 20px;
      }
      .qr-frame {
        width: var(--size);
        height: var(--size);
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      a#qr-link {
        display: inline-block;
        border-radius: 8px;
        overflow: hidden;
        display: block;
      }
      img#qr-image {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: contain;
        transition: opacity 400ms ease;
        opacity: 1;
      }
      img.fade-out {
        opacity: 0;
      }
      .timer {
        font-size: 14px;
        margin: 6px 0;
        color: #333;
      }
      .progress {
        height: 12px;
        background: #eee;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
      }
      .progress > .bar {
        height: 100%;
        width: 100%;
        background: var(--green);
        transform-origin: left;
        will-change: transform;
        transition: background-color 200ms linear;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Dynamic QR - valid 30s</h1>
        <div class="qr-frame">
          <a id="qr-link" href="#" target="_self" rel="noopener noreferrer">
            <img id="qr-image" src="" alt="QR code" />
          </a>
        </div>

        <div class="timer">Expires in: <strong id="countdown">--s</strong></div>
        <div class="progress" aria-hidden="true">
          <div class="bar" id="progress-bar"></div>
        </div>


      </div>
    </div>

    <script>
      (function () {
        const VALIDITY_MS = 30_000; 
        const qrImage = document.getElementById("qr-image");
        const qrLink = document.getElementById("qr-link");
        const countdown = document.getElementById("countdown");
        const progressBar = document.getElementById("progress-bar");

        let current = null;
        let nextQR = null;
        let ticker = null;

        async function fetchQR() {
          try {
            const r = await fetch("/qrcode", { cache: "no-store" });
            if (!r.ok) throw new Error("Failed to fetch QR: " + r.status);
            return await r.json();
          } catch (err) {
            console.error(err);
            return null;
          }
        }

        function swapTo(qr) {
          if (!qr) return;
          qrLink.href = qr.scanUrl || "/scan?token=" + qr.token;

          qrImage.classList.add("fade-out");
          setTimeout(() => {
            qrImage.src = qr.dataUrl;
            qrImage.classList.remove("fade-out");
          }, 260);
        }

        function preloadDataUrl(dataUrl) {
          if (!dataUrl) return;
          const pre = new Image();
          pre.src = dataUrl;
        }

        function updateUI() {
          if (!current) return;
          const tokenMs = Number(current.token);
          const remainingMs = tokenMs + VALIDITY_MS - Date.now();
          const remainingSec = Math.max(0, Math.ceil(remainingMs / 1000));
          countdown.textContent = remainingSec + "s";

          const pct = Math.max(0, remainingMs / VALIDITY_MS);
          progressBar.style.transform = `scaleX(${Math.max(0, pct)})`;
          progressBar.style.background =
            remainingMs > 0 ? "#2ecc71" : "#e74c3c";

          if (remainingMs <= 2500 && !nextQR) {
            fetchQR().then((q) => {
              if (q) {
                nextQR = q;
                preloadDataUrl(q.dataUrl);
              }
            });
          }

          if (remainingMs <= 0) {
            if (nextQR) {
              current = nextQR;
              nextQR = null;
              swapTo(current);
              fetchQR().then((q) => {
                if (q) {
                  nextQR = q;
                  preloadDataUrl(q.dataUrl);
                }
              });
            } else {
              fetchQR().then((q) => {
                if (q) {
                  current = q;
                  swapTo(current);
                  fetchQR().then((n) => {
                    if (n) {
                      nextQR = n;
                      preloadDataUrl(n.dataUrl);
                    }
                  });
                }
              });
            }
          }
        }

        async function start() {
          current = await fetchQR();
          if (!current) {
            countdown.textContent = "error";
            return;
          }
          qrImage.src = current.dataUrl;
          qrLink.href = current.scanUrl || "/scan?token=" + current.token;

          fetchQR().then((q) => {
            if (q) {
              nextQR = q;
              preloadDataUrl(q.dataUrl);
            }
          });

          updateUI();
          ticker = setInterval(updateUI, 50);
        }

        document.addEventListener("DOMContentLoaded", start);
      })();
    </script>
  </body>
</html>
